/**
 * @description Test class for FS_LogStartAction
 * @author FlowSense
 * @version 1.0
 */
@isTest
private class FS_LogStartActionTest {
    
    /**
     * @description Test successful flow logging start with all fields
     */
    @isTest
    static void testStartLoggingSuccess() {
        // Create request with all fields populated
        FS_LogStartAction.LogStartRequest request = new FS_LogStartAction.LogStartRequest();
        request.flowApiName = 'Test_Account_Flow';
        request.flowLabel = 'Test Account Flow';
        request.flowVersion = 1.0;
        request.interviewId = 'TEST_INTERVIEW_123';
        request.triggerContext = 'Platform Event';
        request.entryRecordId = UserInfo.getUserId(); // Use a valid record ID
        
        Test.startTest();
        
        List<FS_LogStartAction.LogStartResult> results = FS_LogStartAction.startLogging(
            new List<FS_LogStartAction.LogStartRequest>{request}
        );
        
        Test.stopTest();
        
        // Verify result
        System.assertEquals(1, results.size(), 'Should return one result');
        System.assertEquals(true, results[0].success, 'Start logging should be successful');
        System.assertNotEquals(null, results[0].runId, 'Run ID should be populated');
        System.assertEquals('TEST_INTERVIEW_123', results[0].interviewId, 'Interview ID should match');
        System.assertEquals('Flow logging started successfully', results[0].message, 'Success message should be correct');
        
        // Verify Flow Run record was created
        FS_Flow_Run__c flowRun = [SELECT Id, Flow_API_Name__c, Flow_Label__c, Interview_Id__c, 
                                  Start_Time__c, Status__c
                                  FROM FS_Flow_Run__c 
                                  WHERE Id = :results[0].runId];
        
        System.assertEquals('Test_Account_Flow', flowRun.Flow_API_Name__c, 'Flow API name should match');
        System.assertEquals('Test Account Flow', flowRun.Flow_Label__c, 'Flow label should match');
        System.assertEquals('TEST_INTERVIEW_123', flowRun.Interview_Id__c, 'Interview ID should match');
        System.assertEquals('Running', flowRun.Status__c, 'Status should be Running');
        System.assertNotEquals(null, flowRun.Start_Time__c, 'Start time should be populated');
    }
    
    /**
     * @description Test flow logging start with minimal required fields only
     */
    @isTest
    static void testStartLoggingMinimalFields() {
        // Create request with only required fields
        FS_LogStartAction.LogStartRequest request = new FS_LogStartAction.LogStartRequest();
        request.flowApiName = 'Minimal_Flow';
        
        Test.startTest();
        
        List<FS_LogStartAction.LogStartResult> results = FS_LogStartAction.startLogging(
            new List<FS_LogStartAction.LogStartRequest>{request}
        );
        
        Test.stopTest();
        
        // Verify result
        System.assertEquals(1, results.size(), 'Should return one result');
        System.assertEquals(true, results[0].success, 'Start logging should be successful');
        System.assertNotEquals(null, results[0].runId, 'Run ID should be populated');
        System.assertNotEquals(null, results[0].interviewId, 'Interview ID should be auto-generated');
        System.assert(results[0].interviewId.startsWith('FS_'), 'Auto-generated interview ID should have FS_ prefix');
        
        // Verify Flow Run record was created with minimal data
        FS_Flow_Run__c flowRun = [SELECT Id, Flow_API_Name__c, Flow_Label__c, Interview_Id__c, 
                                  Start_Time__c, Status__c
                                  FROM FS_Flow_Run__c 
                                  WHERE Id = :results[0].runId];
        
        System.assertEquals('Minimal_Flow', flowRun.Flow_API_Name__c, 'Flow API name should match');
        System.assertEquals('Running', flowRun.Status__c, 'Status should be Running');
        System.assertEquals(results[0].interviewId, flowRun.Interview_Id__c, 'Interview ID should match result');
    }
    
    /**
     * @description Test auto-generation of interview ID when not provided
     */
    @isTest
    static void testAutoGeneratedInterviewId() {
        // Create request without interview ID
        FS_LogStartAction.LogStartRequest request = new FS_LogStartAction.LogStartRequest();
        request.flowApiName = 'Auto_ID_Flow';
        request.flowLabel = 'Auto ID Flow';
        
        Test.startTest();
        
        List<FS_LogStartAction.LogStartResult> results = FS_LogStartAction.startLogging(
            new List<FS_LogStartAction.LogStartRequest>{request}
        );
        
        Test.stopTest();
        
        // Verify result has auto-generated interview ID
        System.assertEquals(1, results.size(), 'Should return one result');
        System.assertEquals(true, results[0].success, 'Start logging should be successful');
        System.assertNotEquals(null, results[0].interviewId, 'Interview ID should be auto-generated');
        System.assert(results[0].interviewId.startsWith('FS_'), 'Auto-generated interview ID should have FS_ prefix');
        System.assert(results[0].interviewId.contains('_'), 'Auto-generated interview ID should contain underscores');
        
        // Verify the Flow Run record has the auto-generated interview ID
        FS_Flow_Run__c flowRun = [SELECT Interview_Id__c FROM FS_Flow_Run__c WHERE Id = :results[0].runId];
        System.assertEquals(results[0].interviewId, flowRun.Interview_Id__c, 'Flow Run should have matching interview ID');
    }
    
    /**
     * @description Test bulk flow logging start with multiple requests
     */
    @isTest
    static void testStartLoggingBulk() {
        // Create multiple requests
        List<FS_LogStartAction.LogStartRequest> requests = new List<FS_LogStartAction.LogStartRequest>();
        
        for (Integer i = 1; i <= 3; i++) {
            FS_LogStartAction.LogStartRequest request = new FS_LogStartAction.LogStartRequest();
            request.flowApiName = 'Bulk_Flow_' + i;
            request.flowLabel = 'Bulk Flow ' + i;
            request.flowVersion = i;
            request.triggerContext = 'Bulk Test ' + i;
            requests.add(request);
        }
        
        Test.startTest();
        
        List<FS_LogStartAction.LogStartResult> results = FS_LogStartAction.startLogging(requests);
        
        Test.stopTest();
        
        // Verify results
        System.assertEquals(3, results.size(), 'Should return three results');
        
        for (Integer i = 0; i < 3; i++) {
            System.assertEquals(true, results[i].success, 'Flow ' + (i+1) + ' logging should be successful');
            System.assertNotEquals(null, results[i].runId, 'Flow ' + (i+1) + ' run ID should be populated');
            System.assertNotEquals(null, results[i].interviewId, 'Flow ' + (i+1) + ' interview ID should be populated');
        }
        
        // Verify all Flow Run records were created
        List<FS_Flow_Run__c> flowRuns = [SELECT Id, Flow_API_Name__c, Flow_Label__c, Status__c
                                         FROM FS_Flow_Run__c 
                                         WHERE Flow_API_Name__c LIKE 'Bulk_Flow_%'
                                         ORDER BY Flow_API_Name__c];
        
        System.assertEquals(3, flowRuns.size(), 'Should create 3 flow run records');
        
        for (Integer i = 0; i < 3; i++) {
            System.assertEquals('Bulk_Flow_' + (i+1), flowRuns[i].Flow_API_Name__c, 'Flow API name should match');
            System.assertEquals('Bulk Flow ' + (i+1), flowRuns[i].Flow_Label__c, 'Flow label should match');
            System.assertEquals('Running', flowRuns[i].Status__c, 'Status should be Running');
        }
    }
    
    /**
     * @description Test flow logging start with blank interview ID (should auto-generate)
     */
    @isTest
    static void testStartLoggingBlankInterviewId() {
        // Create request with blank interview ID
        FS_LogStartAction.LogStartRequest request = new FS_LogStartAction.LogStartRequest();
        request.flowApiName = 'Blank_ID_Flow';
        request.interviewId = ''; // Blank string should trigger auto-generation
        
        Test.startTest();
        
        List<FS_LogStartAction.LogStartResult> results = FS_LogStartAction.startLogging(
            new List<FS_LogStartAction.LogStartRequest>{request}
        );
        
        Test.stopTest();
        
        // Verify result has auto-generated interview ID
        System.assertEquals(1, results.size(), 'Should return one result');
        System.assertEquals(true, results[0].success, 'Start logging should be successful');
        System.assertNotEquals(null, results[0].interviewId, 'Interview ID should be auto-generated');
        System.assertNotEquals('', results[0].interviewId, 'Interview ID should not be blank');
        System.assert(results[0].interviewId.startsWith('FS_'), 'Auto-generated interview ID should have FS_ prefix');
    }
    
    /**
     * @description Test flow logging with special characters in flow name
     */
    @isTest
    static void testStartLoggingSpecialCharacters() {
        // Create request with special characters
        FS_LogStartAction.LogStartRequest request = new FS_LogStartAction.LogStartRequest();
        request.flowApiName = 'Special_Flow_123';
        request.flowLabel = 'Special Flow with Üñíçødé & Symbols!';
        request.triggerContext = 'Platform Event with "quotes" and <tags>';
        
        Test.startTest();
        
        List<FS_LogStartAction.LogStartResult> results = FS_LogStartAction.startLogging(
            new List<FS_LogStartAction.LogStartRequest>{request}
        );
        
        Test.stopTest();
        
        // Verify result
        System.assertEquals(1, results.size(), 'Should return one result');
        System.assertEquals(true, results[0].success, 'Start logging should be successful even with special characters');
        
        // Verify Flow Run record was created with special characters preserved
        FS_Flow_Run__c flowRun = [SELECT Flow_API_Name__c, Flow_Label__c 
                                  FROM FS_Flow_Run__c 
                                  WHERE Id = :results[0].runId];
        
        System.assertEquals('Special_Flow_123', flowRun.Flow_API_Name__c, 'Flow API name with special chars should match');
        System.assertEquals('Special Flow with Üñíçødé & Symbols!', flowRun.Flow_Label__c, 'Flow label with special chars should match');
    }
    
    /**
     * @description Test flow logging with very long flow names and labels
     */
    @isTest
    static void testStartLoggingLongNames() {
        // Create request with long names (within Salesforce limits)
        String longApiName = 'Very_Long_Flow_API_Name_That_Tests_Field_Length_Limits_123456789';
        String longLabel = 'Very Long Flow Label That Tests Field Length Limits And Ensures We Handle Longer Names Properly Without Truncation Issues';
        
        FS_LogStartAction.LogStartRequest request = new FS_LogStartAction.LogStartRequest();
        request.flowApiName = longApiName;
        request.flowLabel = longLabel;
        
        Test.startTest();
        
        List<FS_LogStartAction.LogStartResult> results = FS_LogStartAction.startLogging(
            new List<FS_LogStartAction.LogStartRequest>{request}
        );
        
        Test.stopTest();
        
        // Verify result
        System.assertEquals(1, results.size(), 'Should return one result');
        System.assertEquals(true, results[0].success, 'Start logging should be successful with long names');
        
        // Verify Flow Run record was created
        FS_Flow_Run__c flowRun = [SELECT Flow_API_Name__c, Flow_Label__c 
                                  FROM FS_Flow_Run__c 
                                  WHERE Id = :results[0].runId];
        
        System.assertEquals(longApiName, flowRun.Flow_API_Name__c, 'Long flow API name should match');
        System.assertEquals(longLabel, flowRun.Flow_Label__c, 'Long flow label should match');
    }
    
    /**
     * @description Test with empty request list
     */
    @isTest
    static void testStartLoggingEmptyList() {
        Test.startTest();
        
        List<FS_LogStartAction.LogStartResult> results = FS_LogStartAction.startLogging(
            new List<FS_LogStartAction.LogStartRequest>()
        );
        
        Test.stopTest();
        
        // Verify empty result
        System.assertEquals(0, results.size(), 'Should return empty result list for empty input');
    }
    
    /**
     * @description Test wrapper classes for proper instantiation
     */
    @isTest
    static void testWrapperClasses() {
        // Test LogStartRequest wrapper
        FS_LogStartAction.LogStartRequest request = new FS_LogStartAction.LogStartRequest();
        request.flowApiName = 'test';
        request.flowLabel = 'test label';
        request.flowVersion = 2.0;
        System.assertEquals('test', request.flowApiName, 'Request wrapper should work correctly');
        System.assertEquals('test label', request.flowLabel, 'Request flow label should be set correctly');
        System.assertEquals(2.0, request.flowVersion, 'Request flow version should be set correctly');
        
        // Test LogStartResult wrapper  
        FS_LogStartAction.LogStartResult result = new FS_LogStartAction.LogStartResult();
        result.success = true;
        result.runId = 'test_run_id';
        result.interviewId = 'test_interview_id';
        result.message = 'test message';
        System.assertEquals(true, result.success, 'Result wrapper should work correctly');
        System.assertEquals('test_run_id', result.runId, 'Result run ID should be set correctly');
        System.assertEquals('test_interview_id', result.interviewId, 'Result interview ID should be set correctly');
        System.assertEquals('test message', result.message, 'Result message should be set correctly');
    }
}
