<template>
    <div class="doc-viewer-container" style={containerStyle}>
        <div class="slds-card">
            <div class="slds-card__header">
                <header class="slds-media slds-media_center slds-has-flexi-truncate">
                    <div class="slds-media__figure">
                        <lightning-icon icon-name="utility:knowledge_base" size="small"></lightning-icon>
                    </div>
                    <div class="slds-media__body">
                        <h2 class="slds-card__header-title">
                            <span>Flow Documentation</span>
                        </h2>
                    </div>
                    <div class="slds-no-flex">
                        <div class="slds-button-group" role="group">
                            <button class="slds-button slds-button_neutral" onclick={toggleEditMode} disabled={isLoading}>
                                <lightning-icon icon-name={editButtonIcon} size="x-small"></lightning-icon>
                                {editButtonLabel}
                            </button>
                            <button class="slds-button slds-button_neutral" onclick={exportDocument} disabled={isLoading}>
                                <lightning-icon icon-name="utility:download" size="x-small"></lightning-icon>
                                Export
                            </button>
                            <button class="slds-button slds-button_brand" onclick={saveDocument} disabled={saveDisabled}>
                                <lightning-icon icon-name="utility:save" size="x-small"></lightning-icon>
                                Save
                            </button>
                        </div>
                    </div>
                </header>
            </div>
            <div class="slds-card__body slds-card__body_inner">
                <!-- Document Selection -->
                <div class="selection-section slds-grid slds-gutters slds-wrap">
                    <div class="slds-col slds-size_1-of-3">
                        <lightning-combobox
                            label="Select Flow"
                            value={selectedFlowId}
                            options={flowOptions}
                            onchange={handleFlowChange}
                            placeholder="Choose a flow...">
                        </lightning-combobox>
                    </div>
                    <div class="slds-col slds-size_1-of-3">
                        <lightning-combobox
                            label="Document Type"
                            value={selectedDocumentType}
                            options={documentTypeOptions}
                            onchange={handleDocumentTypeChange}
                            placeholder="Select document type...">
                        </lightning-combobox>
                    </div>
                    <div class="slds-col slds-size_1-of-3">
                        <lightning-input
                            type="search"
                            label="Search Documents"
                            value={searchTerm}
                            onchange={handleSearchChange}
                            placeholder="Search documentation...">
                        </lightning-input>
                    </div>
                </div>

                <!-- Document List -->
                <div class="document-list-section slds-m-top_medium" if:false={selectedDocument}>
                    <template if:true={isLoading}>
                        <div class="loading-container">
                            <lightning-spinner alternative-text="Loading documents..." variant="brand"></lightning-spinner>
                        </div>
                    </template>
                    
                    <template if:false={isLoading}>
                        <div class="slds-grid slds-gutters slds-wrap">
                            <template for:each={filteredDocuments} for:item="doc">
                                <div key={doc.Id} class="slds-col slds-size_1-of-2 slds-large-size_1-of-3">
                                    <div class="document-card" onclick={handleDocumentSelect} data-doc-id={doc.Id}>
                                        <div class="doc-header">
                                            <lightning-icon icon-name={doc.iconName} size="small"></lightning-icon>
                                            <h3 class="doc-title">{doc.Title}</h3>
                                        </div>
                                        <div class="doc-meta">
                                            <div class="meta-item">
                                                <span class="meta-label">Type:</span>
                                                <span class="meta-value">{doc.DocumentType}</span>
                                            </div>
                                            <div class="meta-item">
                                                <span class="meta-label">Updated:</span>
                                                <span class="meta-value">{doc.LastModifiedDate}</span>
                                            </div>
                                            <div class="meta-item">
                                                <span class="meta-label">Size:</span>
                                                <span class="meta-value">{doc.ContentSize}</span>
                                            </div>
                                        </div>
                                        <div class="doc-preview">
                                            {doc.Description}
                                        </div>
                                        <div class="doc-actions">
                                            <lightning-button-icon
                                                icon-name="utility:preview"
                                                variant="border-filled"
                                                size="small"
                                                title="Preview"
                                                onclick={handlePreview}
                                                data-doc-id={doc.Id}>
                                            </lightning-button-icon>
                                            <lightning-button-icon
                                                icon-name="utility:download"
                                                variant="border-filled"
                                                size="small"
                                                title="Download"
                                                onclick={handleDownload}
                                                data-doc-id={doc.Id}>
                                            </lightning-button-icon>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                        
                        <template if:true={noDocuments}>
                            <div class="no-documents">
                                <lightning-icon icon-name="utility:info" size="medium"></lightning-icon>
                                <h3>No documents found</h3>
                                <p>No documentation matches your current filters.</p>
                                <button class="slds-button slds-button_brand" onclick={createNewDocument}>
                                    Create New Document
                                </button>
                            </div>
                        </template>
                    </template>
                </div>

                <!-- Document Viewer/Editor -->
                <template if:true={selectedDocument}>
                    <div class="document-viewer-section slds-m-top_medium">
                        <!-- Document Header -->
                        <div class="viewer-header slds-grid slds-gutters">
                            <div class="slds-col slds-size_2-of-3">
                                <div class="breadcrumb">
                                    <span class="breadcrumb-item" onclick={goBack}>Documents</span>
                                    <lightning-icon icon-name="utility:chevronright" size="xx-small"></lightning-icon>
                                    <span class="breadcrumb-current">{selectedDocument.Title}</span>
                                </div>
                                <template if:false={isEditMode}>
                                    <h1 class="document-title">{selectedDocument.Title}</h1>
                                </template>
                                <template if:true={isEditMode}>
                                    <lightning-input
                                        type="text"
                                        value={selectedDocument.Title}
                                        onchange={handleTitleChange}
                                        class="title-input">
                                    </lightning-input>
                                </template>
                            </div>
                            <div class="slds-col slds-size_1-of-3">
                                <div class="document-metadata">
                                    <dl class="slds-list_horizontal">
                                        <dt class="slds-item_label">Type:</dt>
                                        <dd class="slds-item_detail">{selectedDocument.DocumentType}</dd>
                                        <dt class="slds-item_label">Flow:</dt>
                                        <dd class="slds-item_detail">{selectedDocument.FlowName}</dd>
                                        <dt class="slds-item_label">Updated:</dt>
                                        <dd class="slds-item_detail">{selectedDocument.LastModifiedDate}</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>

                        <!-- Document Content -->
                        <div class="document-content slds-m-top_medium">
                            <template if:false={isEditMode}>
                                <!-- Read-only view -->
                                <div class="content-viewer" lwc:dom="manual"></div>
                            </template>
                            
                            <template if:true={isEditMode}>
                                <!-- Edit mode -->
                                <div class="content-editor">
                                    <lightning-textarea
                                        label="Document Content"
                                        value={documentContent}
                                        onchange={handleContentChange}
                                        rows="20"
                                        class="content-textarea">
                                    </lightning-textarea>
                                    
                                    <!-- Rich text toolbar (if needed) -->
                                    <div class="editor-toolbar slds-m-top_small">
                                        <div class="slds-button-group" role="group">
                                            <button class="slds-button slds-button_icon slds-button_icon-border" onclick={formatBold} title="Bold">
                                                <lightning-icon icon-name="utility:bold" size="x-small"></lightning-icon>
                                            </button>
                                            <button class="slds-button slds-button_icon slds-button_icon-border" onclick={formatItalic} title="Italic">
                                                <lightning-icon icon-name="utility:italic" size="x-small"></lightning-icon>
                                            </button>
                                            <button class="slds-button slds-button_icon slds-button_icon-border" onclick={formatCode} title="Code">
                                                <lightning-icon icon-name="utility:code" size="x-small"></lightning-icon>
                                            </button>
                                            <button class="slds-button slds-button_icon slds-button_icon-border" onclick={insertLink} title="Insert Link">
                                                <lightning-icon icon-name="utility:link" size="x-small"></lightning-icon>
                                            </button>
                                            <button class="slds-button slds-button_icon slds-button_icon-border" onclick={insertImage} title="Insert Image">
                                                <lightning-icon icon-name="utility:image" size="x-small"></lightning-icon>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Document Attachments -->
                        <template if:true={selectedDocument.hasAttachments}>
                            <div class="attachments-section slds-m-top_medium">
                                <h3 class="slds-text-heading_small">Attachments</h3>
                                <div class="attachment-list slds-m-top_small">
                                    <template for:each={selectedDocument.attachments} for:item="attachment">
                                        <div key={attachment.Id} class="attachment-item">
                                            <lightning-icon icon-name={attachment.iconName} size="small"></lightning-icon>
                                            <span class="attachment-name">{attachment.Name}</span>
                                            <span class="attachment-size">{attachment.Size}</span>
                                            <lightning-button-icon
                                                icon-name="utility:download"
                                                variant="bare"
                                                size="small"
                                                title="Download"
                                                onclick={downloadAttachment}
                                                data-attachment-id={attachment.Id}>
                                            </lightning-button-icon>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>

                        <!-- AI Analysis Section (if available) -->
                        <template if:true={aiAnalysisAvailable}>
                            <div class="ai-analysis-section slds-m-top_medium">
                                <div class="slds-card slds-card_boundary">
                                    <div class="slds-card__header">
                                        <header class="slds-media slds-media_center">
                                            <div class="slds-media__figure">
                                                <lightning-icon icon-name="utility:einstein" size="small" variant="warning"></lightning-icon>
                                            </div>
                                            <div class="slds-media__body">
                                                <h3 class="slds-card__header-title">AI Analysis Results</h3>
                                            </div>
                                        </header>
                                    </div>
                                    <div class="slds-card__body slds-card__body_inner">
                                        <div class="ai-insights" lwc:dom="manual"></div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
        </div>
    </div>
</template>