<template>
    <div class="dashboard-container">
        <div class="modern-card">
            <div class="card-header">
                <div class="header-icon">
                    <lightning-icon icon-name="utility:dashboard" size="medium"></lightning-icon>
                </div>
                <div class="header-content">
                    <h1 class="card-title">Dashboard</h1>
                    <p class="card-subtitle">Comprehensive flow monitoring and governance insights</p>
                </div>
                <div class="header-actions">
                    <div class="action-buttons">
                        <lightning-button 
                            variant="neutral" 
                            icon-name="utility:refresh" 
                            label="Refresh" 
                            onclick={handleRefresh}
                            disabled={isRefreshing}>
                        </lightning-button>
                        <template if:true={isRefreshing}>
                            <lightning-spinner alternative-text="Refreshing..." size="small" class="refresh-spinner"></lightning-spinner>
                        </template>
                    </div>
                </div>
            </div>
            
            <div class="card-content">
                <!-- Enhanced Summary Cards -->
                <div class="metrics-section">
                    <h3 class="section-title">
                        <lightning-icon icon-name="utility:chart" size="small"></lightning-icon>
                        Key Metrics
                    </h3>
                    <div class="metrics-grid">
                        <div class="metric-card primary">
                            <div class="metric-icon">
                                <lightning-icon icon-name="utility:play" size="medium"></lightning-icon>
                            </div>
                            <div class="metric-content">
                                <div class="metric-value">{totalExecutions}</div>
                                <div class="metric-label">Total Executions</div>
                                <div class="metric-trend positive">
                                    <lightning-icon icon-name="utility:arrowup" size="x-small"></lightning-icon>
                                    +12% from last month
                                </div>
                            </div>
                        </div>
                        
                        <div class="metric-card success">
                            <div class="metric-icon">
                                <lightning-icon icon-name="utility:success" size="medium"></lightning-icon>
                            </div>
                            <div class="metric-content">
                                <div class="metric-value">{averagePerformanceScore}%</div>
                                <div class="metric-label">Avg Performance Score</div>
                                <div class="metric-trend positive">
                                    <lightning-icon icon-name="utility:arrowup" size="x-small"></lightning-icon>
                                    +5% improvement
                                </div>
                            </div>
                        </div>
                        
                        <div class="metric-card warning">
                            <div class="metric-icon">
                                <lightning-icon icon-name="utility:warning" size="medium"></lightning-icon>
                            </div>
                            <div class="metric-content">
                                <div class="metric-value">{highRiskFlows}</div>
                                <div class="metric-label">High Risk Flows</div>
                                <div class="metric-trend negative">
                                    <lightning-icon icon-name="utility:arrowdown" size="x-small"></lightning-icon>
                                    -2 from last week
                                </div>
                            </div>
                        </div>
                        
                        <div class="metric-card secondary">
                            <div class="metric-icon">
                                <lightning-icon icon-name="utility:clock" size="medium"></lightning-icon>
                            </div>
                            <div class="metric-content">
                                <div class="metric-value">{averageExecutionTime}ms</div>
                                <div class="metric-label">Avg Execution Time</div>
                                <div class="metric-trend neutral">
                                    <lightning-icon icon-name="utility:dash" size="x-small"></lightning-icon>
                                    No change
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Compact Filter Controls -->
                <div class="filter-section compact">
                    <div class="filter-header">
                        <h3 class="filter-title">
                            <lightning-icon icon-name="utility:filter" size="small"></lightning-icon>
                            Filters
                        </h3>
                    </div>
                    <div class="filter-controls">
                        <div class="filter-inputs">
                            <lightning-combobox
                                name="timeRange"
                                label="Time Range"
                                value={selectedTimeRange}
                                placeholder="Select range"
                                options={timeRangeOptions}
                                onchange={handleTimeRangeChange}
                                variant="label-hidden">
                            </lightning-combobox>
                            
                            <lightning-combobox
                                name="riskLevel"
                                label="Risk Level"
                                value={selectedRiskLevel}
                                placeholder="All risk levels"
                                options={riskLevelOptions}
                                onchange={handleRiskLevelChange}
                                variant="label-hidden">
                            </lightning-combobox>
                            
                            <lightning-input
                                type="search"
                                label="Search Flows"
                                value={searchTerm}
                                placeholder="Search flows..."
                                onchange={handleSearchChange}
                                variant="label-hidden">
                            </lightning-input>
                        </div>
                        
                        <div class="filter-actions">
                            <lightning-button
                                variant="brand"
                                label="Search"
                                icon-name="utility:search"
                                onclick={handleApplyFilters}
                                disabled={isLoading}
                                class="search-button">
                            </lightning-button>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced Flow Analysis Table -->
                <div class="table-section">
                    <div class="table-header">
                        <h3 class="section-title">
                            <lightning-icon icon-name="utility:table" size="small"></lightning-icon>
                            Flow Analysis
                        </h3>
                        <div class="table-actions">
                            <lightning-button variant="neutral" icon-name="utility:download" label="Export" onclick={exportData}></lightning-button>
                        </div>
                    </div>
                    <div class="table-container">
                        <lightning-datatable
                            key-field="id"
                            data={flowAnalysisData}
                            columns={columns}
                            hide-checkbox-column="true"
                            show-row-number-column="true"
                            onrowaction={handleRowAction}
                            class="modern-table">
                        </lightning-datatable>
                    </div>
                </div>
                
                <!-- Loading Spinner -->
                <template if:true={isLoading}>
                    <div class="loading-overlay">
                        <lightning-spinner alternative-text="Loading dashboard data..." size="medium" class="modern-spinner"></lightning-spinner>
                        <p class="loading-text">Analyzing flow performance data...</p>
                    </div>
                </template>
            </div>
        </div>
        
        <!-- Enhanced Flow Detail Modal -->
        <template if:true={showFlowDetailModal}>
            <section role="dialog" tabindex="-1" class="modal-overlay">
                <div class="modal-container">
                    <header class="modal-header">
                        <div class="modal-title">
                            <lightning-icon icon-name="utility:flow" size="small"></lightning-icon>
                            <h2>{modalTitle}</h2>
                        </div>
                        <lightning-button-icon 
                            icon-name="utility:close"
                            alternative-text="Close"
                            onclick={handleCloseModal}
                            class="modal-close">
                        </lightning-button-icon>
                    </header>
                    
                    <div class="modal-content">
                        <template if:true={selectedFlowDetails}>
                            <!-- Flow Overview -->
                            <div class="detail-section">
                                <h3 class="detail-title">Overview</h3>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <span class="detail-label">Performance Score</span>
                                        <span class={performanceClass}>{selectedFlowDetails.performanceScore}%</span>
                                        <div class={performanceIndicatorClass}>{performanceLabel}</div>
                                    </div>
                                    
                                    <div class="detail-item">
                                        <span class="detail-label">Risk Level</span>
                                        <span class={riskIndicatorClass}>{selectedFlowDetails.riskLevel}</span>
                                    </div>
                                    
                                    <div class="detail-item">
                                        <span class="detail-label">Complexity Score</span>
                                        <span class="detail-value">{selectedFlowDetails.complexityScore}</span>
                                    </div>
                                    
                                    <div class="detail-item">
                                        <span class="detail-label">Last Analysis</span>
                                        <lightning-formatted-date-time 
                                            value={selectedFlowDetails.lastAnalysisDate}
                                            year="numeric"
                                            month="short"
                                            day="2-digit"
                                            hour="2-digit"
                                            minute="2-digit">
                                        </lightning-formatted-date-time>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Execution Statistics -->
                            <div class="detail-section">
                                <h3 class="detail-title">Execution Statistics (Last 30 Days)</h3>
                                <div class="stats-grid">
                                    <div class="stat-item">
                                        <span class="stat-value">{selectedFlowDetails.totalExecutions}</span>
                                        <span class="stat-label">Total Executions</span>
                                    </div>
                                    
                                    <div class="stat-item">
                                        <span class="stat-value">{selectedFlowDetails.recentExecutions}</span>
                                        <span class="stat-label">Recent Executions (7 days)</span>
                                    </div>
                                    
                                    <div class="stat-item">
                                        <span class="stat-value">{selectedFlowDetails.averageDuration}</span>
                                        <span class="stat-label">Avg Duration (ms)</span>
                                    </div>
                                    
                                    <div class="stat-item">
                                        <span class="stat-value">{selectedFlowDetails.averageCpuTime}</span>
                                        <span class="stat-label">Avg CPU Time (ms)</span>
                                    </div>
                                    
                                    <div class="stat-item">
                                        <span class="stat-value">{selectedFlowDetails.minDuration}</span>
                                        <span class="stat-label">Min Duration (ms)</span>
                                    </div>
                                    
                                    <div class="stat-item">
                                        <span class="stat-value">{selectedFlowDetails.maxDuration}</span>
                                        <span class="stat-label">Max Duration (ms)</span>
                                    </div>
                                    
                                    <div class="stat-item">
                                        <span class="stat-value">{selectedFlowDetails.averageSoqlCount}</span>
                                        <span class="stat-label">Avg SOQL Count</span>
                                    </div>
                                    
                                    <div class="stat-item">
                                        <span class="stat-value">{selectedFlowDetails.averageDmlCount}</span>
                                        <span class="stat-label">Avg DML Count</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Analysis Summary -->
                            <template if:true={selectedFlowDetails.analysisSummary}>
                                <div class="detail-section">
                                    <h3 class="detail-title">Analysis Summary</h3>
                                    <div class="analysis-summary">
                                        <lightning-formatted-text value={selectedFlowDetails.analysisSummary}></lightning-formatted-text>
                                    </div>
                                </div>
                            </template>
                        </template>
                    </div>
                    
                    <footer class="modal-footer">
                        <lightning-button variant="neutral" label="Close" onclick={handleCloseModal}></lightning-button>
                        <lightning-button variant="brand" label="View Details" onclick={navigateToDetails}></lightning-button>
                    </footer>
                </div>
            </section>
            <div class="modal-backdrop"></div>
        </template>
    </div>
</template>